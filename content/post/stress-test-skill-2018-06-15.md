---
title: "性能优化/压力测试 - 方法论"
date: 2018-06-15T01:43:02+08:00
lastmod: 2018-06-15T01:43:02+08:00
draft: false
tags: ["stress-test"]
categories: ["skill"]
author: "weiweimilk"
autoCollapseToc: true

---
# 背景

最近在做golang程序的性能优化，大约持续了2天，相关优化思路和思考跟大家分享下。

# 正文

凡事都是有相关方法论，所以在做之前我们应该想好做事的思路，压力测试实际就是一个很好的例子，包括以下几步：

* 定义吞吐量的业务含义：比如计算系统：每秒多少次计算？数据库系统，每秒能读多少数据，写多少数据？api借口，每秒可以处理多少请求？
* 目标吞吐量：这个是目标，是需要多方协商
* 吞吐量现状：如何知道现状的吞吐量是多少呢？这个就需要定义测试场景，指定相应的压测方案，并编写相关压测工具，
	* 制定场景：比如计算系统可以分简单计算和复杂计算两个典型场景，看下这两个典型场景下，系统可以达到的性能。
	* 压测工具：一般思路是编写相关客户端，模拟数据源或用户，向被压测的系统发起真实请求，压测工具是否可以按预期发起请求，最好反复确认，我开始压测的时候，一直打印错误日志，一开始以为是被压测程序的问题，经过反馈定位，发现是自己写的压测客户端有bug和相关请求参数请求不合理，导致请求量一直起不来。
	* 第一版数据：一整套压测工具整好了，经过压测，得出初步的压测结论，这个时候就知道现状与目标的差距的。

那么下面就看如何来缩小现状与目标的差距，即如何来优化程序代码，根据2/8原则，要找关键点来优化，往往可以起到事半功倍的效果

一个系统，一般可以分为CPU密集型和MEMORY密集型，一般需要优化较多的一般都是CPU密集型（当然内存也有哈），我这次主要针对的是CPU优化，所以下面主要讲讲有关CPU的。

一般来说，一个系统的CPU资源瓶颈主要集中在下面几个部分：

* 字符串操作
* 锁操作
* 内存大量copy
* 网络链接
* 大量同步操作（网络链接、磁盘IO）


每种语言，都有相应的性能优化工具，比如golang语音？？对应特定语言的优化思路，我目前还不太深入，下面还需要深入了解，大家可以google下，这块资料也比较多。

我这次优化的是golang语言的非WEB程序，主要优化思路如下：

* 利用pprof得到函数级别的耗时图，通过这个可以查看调用链和函数级别的耗时，以及golang的GC情况
	* go tool pprof  --seconds 300 http://host:port/debug/pprof/profile
* 利用go-torch画出火焰图，可以看出某个耗时的函数详细的调用链，有针对的找到可优化的函数
	* go-torch -u http://host:port -t 30

通过上面的两个步骤，成功将性能提升4倍，bingooooo

# END

* 做事要有方法论，做之前多想思路，往往事半功倍
* 2/8原则，找到那个只需花20%精力便可解决的80%的问题


----
如果你对本篇文章有任何问题，请邮件联系我。











